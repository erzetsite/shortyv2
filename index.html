<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Shorty: A free, open-source, minimal URL shortener." />
  <title>Shorty – Minimal URL Shortener</title>

  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
          colors: {
            brand: { 400: '#3b82f6', 500: '#2563eb' }
          },
          borderRadius: { 12: '12px' },
          boxShadow: { soft: '0 1px 3px rgba(0,0,0,.1), 0 1px 2px rgba(0,0,0,.06)' }
        }
      }
    }
  </script>

  <!-- Original scripts preserved -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js"></script>
  <style>
    html { scroll-behavior: smooth; }
    html.dark body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-color: #111827;
      z-index: -10;
      transform: translateX(0%);
      transition: transform .5s cubic-bezier(.77,0,.175,1);
    }
  </style>
</head>

<body
  class="bg-[#fafafa] dark:bg-[#111827] text-gray-900 dark:text-gray-100 font-sans transition-colors duration-300"
  x-data="shortyApp()"
  x-init="initDarkMode(); initTurnstileWatcher()"
>
  <!-- Dark-mode toggle -->
  <button
    @click="toggleDarkMode"
    class="fixed top-4 right-4 z-30 bg-white dark:bg-gray-800 rounded-full p-2 shadow-soft transition duration-300"
    aria-label="Toggle dark mode"
  >
    <svg x-show="!isDarkMode" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
    </svg>
    <svg x-show="isDarkMode" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round"
            d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
    </svg>
  </button>

  <!-- Header -->
  <header class="pt-10 pb-6">
    <h1 class="text-center text-3xl font-semibold">
      <a href="https://rzsite.my.id" target="_blank" class="text-brand-500 hover:underline">RZ SITE</a>
    </h1>
  </header>

  <main class="max-w-4xl mx-auto px-4 grid md:grid-cols-2 gap-8">
    <!-- Shorten -->
    <section class="bg-white dark:bg-[#1f2937] rounded-12 shadow-soft p-6 space-y-5">
      <h2 class="text-xl font-semibold">Create a Short Link</h2>
      <form @submit.prevent="generateShortUrl">
        <label class="block text-sm font-medium mb-1">Original URL</label>
        <input
          type="url"
          x-model="longUrlInput"
          class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-transparent focus:ring-2 focus:ring-brand-500 transition"
          placeholder="https://example.com"
          required
        />
        <input type="hidden" x-model="turnstileToken" />
        <button
          type="submit"
          :disabled="generating"
          class="w-full mt-4 bg-brand-500 hover:bg-brand-600 disabled:opacity-60 text-white font-medium rounded-md py-2 transition"
        >
          <span x-show="!generating">Shorten URL</span>
          <span x-show="generating">Generating…</span>
        </button>
        <div id="turnstile-widget" class="mt-4 flex justify-center"></div>
      </form>

      <div x-show="generatedUrl" x-transition class="mt-4 p-3 bg-green-100 dark:bg-green-900 rounded-md">
        Short URL: <a :href="generatedUrl" target="_blank" class="font-medium underline" x-text="generatedUrl"></a>
        <button @click="copyToClipboard(generatedUrl)" class="ml-2 text-sm text-brand-500">[Copy]</button>
        <span x-show="copied" class="ml-2 text-xs">Copied!</span>
      </div>
      <div x-show="generateError" class="mt-4 p-3 bg-red-100 dark:bg-red-900 rounded-md" x-text="generateError"></div>
    </section>

    <!-- Stats -->
    <section class="bg-white dark:bg-[#1f2937] rounded-12 shadow-soft p-6 space-y-5">
      <h2 class="text-xl font-semibold">Check Link Stats</h2>
      <form @submit.prevent="checkUrlStats">
        <label class="block text-sm font-medium mb-1">Short URL</label>
        <input
          type="url"
          x-model="checkUrlInput"
          :placeholder="shortDomainPlaceholder"
          class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-transparent focus:ring-2 focus:ring-brand-500 transition"
          required
        />
        <button
          type="submit"
          :disabled="checking"
          class="w-full mt-4 bg-gray-600 hover:bg-gray-700 disabled:opacity-60 text-white font-medium rounded-md py-2 transition"
        >
          <span x-show="!checking">Check Stats</span>
          <span x-show="checking">Checking…</span>
        </button>
      </form>

      <div x-show="statsResult" x-transition class="mt-4 p-3 bg-blue-100 dark:bg-blue-900 rounded-md">
        <p><strong>Original:</strong> <a :href="statsResult.originalUrl" target="_blank" class="underline" x-text="statsResult.originalUrl"></a></p>
        <p><strong>Clicks:</strong> <span x-text="statsResult.clicks"></span></p>
        <p><strong>Created:</strong> <span x-text="statsResult.createdAt"></span></p>
      </div>
      <div x-show="checkError" class="mt-4 p-3 bg-red-100 dark:bg-red-900 rounded-md" x-text="checkError"></div>
    </section>
  </main>

  <!-- Report modal (unchanged) -->
  <div x-show="showReportModal" x-cloak class="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-[#1f2937] rounded-12 shadow-soft p-6 max-w-md w-full" @click.stop>
      <h3 class="text-lg font-semibold mb-2">Report Abuse</h3>
      <input
        x-model="reportUrlInput"
        placeholder="Enter URL"
        class="w-full border border-gray-300 dark:border-gray-600 rounded-md p-2 bg-transparent"
      />
      <div id="report-turnstile-widget" class="mt-3 flex justify-center"></div>
      <input type="hidden" x-model="reportTurnstileToken" />
      <div x-show="reportMessage" class="mt-2 text-sm" x-text="reportMessage"></div>
      <div class="flex gap-3 mt-4">
        <button
          @click="submitReport"
          :disabled="submittingReport || !reportTurnstileToken"
          class="flex-1 bg-brand-500 hover:bg-brand-600 disabled:opacity-60 text-white rounded-md py-2"
        >
          <span x-show="!submittingReport">Submit</span><span x-show="submittingReport">Sending…</span>
        </button>
        <button @click="showReportModal=false; resetReportForm()" class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-md py-2">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="text-center py-8 text-sm text-gray-500 dark:text-gray-400">
    <p class="mb-2">
      &copy; <span id="year"></span> Shorty – Free & Private
    </p>
    <button @click="showReportModal=true" class="underline">Report Abuse</button>
  </footer>

  <!-- Original Alpine script preserved -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    // Auto-year
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
  <script>
    // Paste original shortyApp() here unchanged
    function shortyApp() {
      const config = window.shortyConfig || {};
      const apiUrl = config.API_WORKER_URL || '';
      const turnstileSiteKey = config.TURNSTILE_SITE_KEY || '';
      const shortDomain = config.SHORT_DOMAIN || window.location.origin;

      return {
        shortDomainPlaceholder: `${shortDomain}/+xyz123`,
        shortDomainExample: `${shortDomain}/+abc`,
        longUrlInput: '',
        generatedUrl: '',
        generateError: '',
        generating: false,
        copied: false,
        turnstileToken: '',
        awaitingTurnstileForSubmit: false,
        checkUrlInput: '',
        statsResult: null,
        checkError: '',
        checking: false,
        showReportModal: false,
        reportUrlInput: '',
        reportTurnstileToken: '',
        submittingReport: false,
        reportMessage: '',
        reportSuccess: false,
        isDarkMode: false,
        toggleClickCount: 0,
        toggleClickTimer: null,
        showToggleMessage: false,

        initDarkMode() {
  // 1. Ambil preferensi yang tersimpan
  const stored = localStorage.getItem('darkMode');
  // 2. Jika belum ada, pakai sistem
  if (stored === null) {
    this.isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
    localStorage.setItem('darkMode', this.isDarkMode); // simpan default
  } else {
    this.isDarkMode = stored === 'true';
  }
  this.applyDarkMode();
},
          this.toggleClickCount++;
          if (this.toggleClickTimer) clearTimeout(this.toggleClickTimer);
          if (this.toggleClickCount >= 5) {
            this.showToggleMessage = true;
            setTimeout(() => { this.showToggleMessage = false; }, 3000);
            this.toggleClickCount = 0;
          }
          this.toggleClickTimer = setTimeout(() => { this.toggleClickCount = 0; }, 3000);
        },
        applyDarkMode() {
          if (this.isDarkMode) document.documentElement.classList.add('dark');
          else document.documentElement.classList.remove('dark');
        },
        async generateShortUrl() {
          this.generating = true;
          this.generatedUrl = '';
          this.generateError = '';
          this.copied = false;
          this.awaitingTurnstileForSubmit = false;
          if (!this.turnstileToken) {
            this.generateError = 'Please complete the CAPTCHA challenge below.';
            this.awaitingTurnstileForSubmit = true;
            this.renderSpecificTurnstile('#turnstile-widget', this.setTurnstileToken);
          } else {
            await this.submitShortenRequest();
          }
        },
        async submitShortenRequest() {
          if (!this.turnstileToken) {
            this.generateError = "CAPTCHA token missing. Please try again.";
            this.generating = false;
            return;
          }
          try {
            if (!apiUrl) throw new Error("API URL is not configured.");
            const response = await fetch(`${apiUrl}/api/create`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ longUrl: this.longUrlInput, 'cf-turnstile-response': this.turnstileToken })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || `HTTP error! status: ${response.status}`);
            this.generatedUrl = result.shortUrl;
            this.generateError = '';
          } catch (error) {
            console.error('Error generating short URL:', error);
            this.generateError = error.message || 'Failed to shorten URL.';
            this.generatedUrl = '';
          } finally {
            this.generating = false;
            this.awaitingTurnstileForSubmit = false;
            try { turnstile.reset('#turnstile-widget'); } catch(e) {}
            this.turnstileToken = '';
          }
        },
        async checkUrlStats() {
          this.checking = true;
          this.statsResult = null;
          this.checkError = '';
          try {
            let shortId = '';
            try { shortId = new URL(this.checkUrlInput).pathname.substring(1); }
            catch (e) { shortId = this.checkUrlInput.split('/').pop(); }
            if (!shortId) throw new Error("Could not extract Short ID.");
            if (!apiUrl) throw new Error("API URL is not configured.");
            const response = await fetch(`${apiUrl}/api/stats/${shortId}`);
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || `HTTP error! status: ${response.status}`);
            result.createdAt = new Date(result.createdAt).toLocaleString();
            this.statsResult = result;
          } catch (error) {
            console.error('Error checking stats:', error);
            this.checkError = error.message || 'Failed to retrieve stats.';
          } finally {
            this.checking = false;
          }
        },
        copyToClipboard(text) {
          navigator.clipboard.writeText(text)
            .then(() => { this.copied = true; setTimeout(() => { this.copied = false; }, 2000); })
            .catch(err => console.error('Failed to copy: ', err));
        },
        setTurnstileToken(token) {
          this.turnstileToken = token;
          if (token && this.awaitingTurnstileForSubmit) {
            this.generateError = '';
            this.submitShortenRequest();
          }
        },
        setReportTurnstileToken(token) { this.reportTurnstileToken = token; },
        initTurnstileWatcher() {
          this.$watch('showReportModal', val => {
            if (val) {
              this.$nextTick(() => {
                this.reportTurnstileToken = '';
                this.renderSpecificTurnstile('#report-turnstile-widget', this.setReportTurnstileToken);
              });
            }
          });
        },
        renderSpecificTurnstile(widgetSelector, callbackMethod) {
          if (typeof turnstile !== 'undefined') {
            const widgetElement = document.querySelector(widgetSelector);
            if (!widgetElement) { console.error(`Turnstile widget container not found: ${widgetSelector}`); return; }
            if (widgetElement.innerHTML.trim() === '') {
              if (!turnstileSiteKey) {
                const errorMsg = 'CAPTCHA Site Key not configured.';
                if (widgetSelector === '#turnstile-widget') this.generateError = errorMsg;
                else { this.reportMessage = errorMsg; this.reportSuccess = false; }
                return;
              }
              turnstile.render(widgetSelector, {
                sitekey: turnstileSiteKey,
                callback: token => { callbackMethod.call(this, token); },
                'expired-callback': () => { callbackMethod.call(this, ''); },
                'error-callback': errorCode => {
                  console.error(`Turnstile error in ${widgetSelector}: ${errorCode}`);
                  const errorMsg = `CAPTCHA error (${errorCode}). Please refresh.`;
                  if (widgetSelector === '#turnstile-widget') this.generateError = errorMsg;
                  else { this.reportMessage = errorMsg; this.reportSuccess = false; }
                  callbackMethod.call(this, '');
                }
              });
            }
          } else {
            const errorMsg = 'Could not load CAPTCHA widget. Please refresh.';
            this.generateError = errorMsg;
            this.reportMessage = errorMsg;
            this.reportSuccess = false;
          }
        },
        async submitReport() {
          this.submittingReport = true;
          this.reportMessage = '';
          this.reportSuccess = false;
          if (!this.reportUrlInput) { this.reportMessage = 'Please enter the URL to report.'; this.submittingReport = false; return; }
          if (!this.reportTurnstileToken) { this.reportMessage = 'Please complete the CAPTCHA challenge.'; this.submittingReport = false; return; }
          try {
            if (!apiUrl) throw new Error("API URL is not configured.");
            const response = await fetch(`${apiUrl}/api/report`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ reportedUrl: this.reportUrlInput, 'cf-turnstile-response': this.reportTurnstileToken })
            });
            const result = await response.json();
            if (response.status === 429) {
              this.reportMessage = result.message || 'You have already reported this recently.';
              this.reportSuccess = false;
            } else if (!response.ok) {
              throw new Error(result.error || `HTTP error! status: ${response.status}`);
            } else {
              this.reportMessage = result.message || 'Report submitted successfully.';
              this.reportSuccess = true;
              setTimeout(() => { this.showReportModal = false; this.resetReportForm(); }, 3000);
            }
          } catch (error) {
            console.error('Error submitting report:', error);
            this.reportMessage = error.message || 'Failed to submit report.';
            this.reportSuccess = false;
          } finally {
            this.submittingReport = false;
            try { turnstile.reset('#report-turnstile-widget'); } catch(e) {}
            this.reportTurnstileToken = '';
          }
        },
        resetReportForm() {
          this.reportUrlInput = '';
          this.reportMessage = '';
          this.reportSuccess = false;
          this.reportTurnstileToken = '';
          try { turnstile.reset('#report-turnstile-widget'); } catch(e) {}
        }
      };
    }
  </script>
</body>
</html>
